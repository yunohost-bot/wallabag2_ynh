From 1a9312652c4ecb7b84aed0328c294b105763f816 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?F=C3=A9lix=20Pi=C3=A9dallu?= <felix@piedallu.me>
Date: Tue, 11 Jun 2024 11:52:33 +0200
Subject: [PATCH 2/4] Configure a custom logout success handler for yunohost
 ldap

---
 app/config/security.yml                       |  2 +-
 app/config/services.yml                       |  4 +++
 .../Security/LogoutSuccessHandler.php         | 27 +++++++++++++++++++
 3 files changed, 32 insertions(+), 1 deletion(-)
 create mode 100644 src/Wallabag/YunoHostBundle/Security/LogoutSuccessHandler.php

diff --git a/app/config/security.yml b/app/config/security.yml
index 675d8905..876f4471 100644
--- a/app/config/security.yml
+++ b/app/config/security.yml
@@ -63,7 +63,7 @@ security:
 
             logout:
                 path:   /logout
-                target: /
+                success_handler: yunohost.logout_success_handler
 
             two_factor:
                 provider: fos_userbundle
diff --git a/app/config/services.yml b/app/config/services.yml
index efdd34d5..584b63c6 100644
--- a/app/config/services.yml
+++ b/app/config/services.yml
@@ -176,6 +176,10 @@ services:
         tags:
             - { name: kernel.event_listener, event: security.interactive_login, method: onInteractiveLogin }
 
+    yunohost.logout_success_handler:
+        class: Wallabag\YunoHostBundle\Security\LogoutSuccessHandler
+
+
     yunohost.ldap:
         class: Symfony\Component\Ldap\LdapClient
         arguments: ["localhost"]
diff --git a/src/Wallabag/YunoHostBundle/Security/LogoutSuccessHandler.php b/src/Wallabag/YunoHostBundle/Security/LogoutSuccessHandler.php
new file mode 100644
index 00000000..b3268243
--- /dev/null
+++ b/src/Wallabag/YunoHostBundle/Security/LogoutSuccessHandler.php
@@ -0,0 +1,27 @@
+<?php
+
+namespace Wallabag\YunoHostBundle\Security;
+
+use Symfony\Component\HttpFoundation\Request;
+use Symfony\Component\HttpFoundation\RedirectResponse;
+use Symfony\Component\Security\Http\Logout\LogoutSuccessHandlerInterface;
+
+/**
+ * Redirects to the SSO logout URL in case of a successful logout.
+ *
+ * @see http://api.symfony.com/3.1/Symfony/Component/Security/Http/Logout/LogoutSuccessHandlerInterface.html
+ */
+class LogoutSuccessHandler implements LogoutSuccessHandlerInterface
+{
+    /**
+     * {@inheritdoc}
+     */
+    public function onLogoutSuccess(Request $request)
+    {
+        // Retrieve the current SSO logout URL
+        $main_domain = exec('cat /etc/yunohost/current_host');
+        $url = 'https://' . $main_domain . '/yunohost/sso/?action=logout';
+
+        return new RedirectResponse($url);
+    }
+}
-- 
2.45.1

